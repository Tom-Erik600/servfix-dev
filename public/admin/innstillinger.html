<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innstillinger - Air-Tech Admin</title>
    <link rel="stylesheet" href="/admin/assets/css/admin.css">
    <link rel="stylesheet" href="/admin/assets/css/innstillinger.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-layout">
        <header class="app-header"></header>

        <main class="main-content">
            <div class="page-header">
                <h1>Innstillinger</h1>
                <p>Konfigurer bedriftsinformasjon, logo og systeminnstillinger</p>
            </div>

            <!-- Bedriftsinformasjon -->
            <div class="card">
                <div class="card-header">
                    <h2>üè¢ Bedriftsinformasjon</h2>
                </div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="company-name">Bedriftsnavn</label>
                            <input type="text" id="company-name" class="form-input" placeholder="Air-Tech AS">
                        </div>
                        
                        <div class="form-group">
                            <label for="company-address">Adresse</label>
                            <input type="text" id="company-address" class="form-input" placeholder="Stanseveien 18, 0975 Oslo">
                        </div>
                        
                        <div class="form-group">
                            <label for="company-phone">Telefon</label>
                            <input type="tel" id="company-phone" class="form-input" placeholder="+47 22 00 00 00">
                        </div>
                        
                        <div class="form-group">
                            <label for="company-email">E-post</label>
                            <input type="email" id="company-email" class="form-input" placeholder="post@air-tech.no">
                        </div>
                        
                        <div class="form-group">
                            <label for="company-cvr">Organisasjonsnummer</label>
                            <input type="text" id="company-cvr" class="form-input" placeholder="123 456 789">
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" id="save-company-info">
                        Lagre bedriftsinformasjon
                    </button>
                </div>
            </div>

            <!-- Logo-opplasting -->
            <div class="card">
                <div class="card-header">
                    <h2>üñºÔ∏è Bedriftslogo</h2>
                </div>
                <div class="card-body">
                    <p style="margin-bottom: 20px; color: var(--text-light);">
                        Last opp logo som vises p√• rapporter. Anbefalt st√∏rrelse: 200x80px, maks 2MB.
                    </p>
                    
                    <div class="logo-upload-area" id="logo-upload-area">
                        <div class="upload-content">
                            <div class="upload-icon">üñºÔ∏è</div>
                            <div class="upload-text">
                                <strong>Klikk her eller dra og slipp logo</strong>
                                <small>PNG, JPG eller SVG - maks 2MB</small>
                            </div>
                        </div>
                        <input type="file" class="hidden-file-input" id="logo-file-input" accept="image/*">
                    </div>
                    
                    <div id="logo-preview-section" style="display: none; margin-top: 16px; text-align: center;">
                        <img id="logo-preview" class="logo-preview" alt="Logo preview">
                        <div class="logo-actions" style="margin-top: 16px;">
                            <button type="button" class="btn btn-primary" id="upload-logo-btn">
                                üì§ Last opp logo
                            </button>
                            <button type="button" class="btn btn-secondary" id="remove-preview-btn">
                                üóëÔ∏è Avbryt
                            </button>
                        </div>
                    </div>
                    
                    <div id="current-logo-section" style="display: none; margin-top: 16px; text-align: center;">
                        <p style="font-size: 14px; color: var(--text-light); margin-bottom: 8px;">Gjeldende logo:</p>
                        <img id="current-logo" class="logo-preview" alt="Current logo">
                        <div class="logo-actions" style="margin-top: 16px;">
                            <button type="button" class="btn btn-secondary" id="remove-current-logo-btn">
                                üóëÔ∏è Fjern gjeldende logo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rapport-innstillinger -->
            <div class="card">
                <div class="card-header">
                    <h2>üìÑ Rapport-innstillinger</h2>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="sender-email">Avsender-epost</label>
                        <input type="email" id="sender-email" class="form-input" placeholder="post@air-tech.no">
                        <small style="color: var(--text-light);">E-postadressen som brukes som avsender for rapporter</small>
                    </div>
                    
                    <div class="settings-grid">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">üîÑ Automatisk sending av rapporter</div>
                                <div class="setting-description">Send rapporter automatisk til kunder n√•r de er ferdigstilt</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto-send-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">üìß Kopier admin p√• alle rapporter</div>
                                <div class="setting-description">Sender en kopi av alle rapporter til admin-epost</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="copy-admin-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-primary" id="save-report-settings">
                        Lagre rapport-innstillinger
                    </button>
                </div>
            </div>

            <!-- Tilbud-innstillinger -->
            <div class="card">
                <div class="card-header">
                    <h2>üìÑ Tilbud-innstillinger</h2>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="forbehold-text">Standard forbehold for alle tilbud</label>
                        <textarea 
                            id="forbehold-text" 
                            class="form-input" 
                            rows="3" 
                            placeholder="Vi forbeholder oss prisendringer ved endringer hos underleverand√∏rer eller store valuta endringer!"
                            style="resize: vertical; min-height: 80px;"
                        ></textarea>
                        <small style="color: #64748b; font-size: 12px; margin-top: 4px; display: block;">
                            Denne teksten vil automatisk inkluderes i alle tilbud som sendes til kunder
                        </small>
                    </div>
                    
                    <div class="settings-grid">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">
                                    <span class="setting-icon">üìÑ</span>
                                    Inkluder forbehold i tilbud
                                </div>
                                <div class="setting-description">
                                    Legg til standard forbehold automatisk i alle tilbud
                                </div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="include-forbehold-toggle" checked>
                                <span class="toggle-slider round"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 24px;">
                        <button type="button" class="btn btn-large btn-primary" onclick="saveQuoteSettings()">
                            üíæ Lagre tilbud-innstillinger
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lagre alle innstillinger -->
            <div class="card">
                <div class="card-body" style="text-align: center;">
                    <button type="button" class="btn btn-primary btn-large" id="save-all-settings">
                        üíæ Lagre alle innstillinger
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p id="loading-text">Laster...</p>
        </div>
    </div>

    <script src="/admin/assets/js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚öôÔ∏è Loading settings page with JSON storage...');
            
            // State
            let selectedLogoFile = null;
            let currentLogoUrl = null;
            let currentSettings = {};
            
            // DOM elements
            const logoUploadArea = document.getElementById('logo-upload-area');
            const logoFileInput = document.getElementById('logo-file-input');
            const logoPreviewSection = document.getElementById('logo-preview-section');
            const logoPreview = document.getElementById('logo-preview');
            const uploadLogoBtn = document.getElementById('upload-logo-btn');
            const removePreviewBtn = document.getElementById('remove-preview-btn');
            const currentLogoSection = document.getElementById('current-logo-section');
            const currentLogo = document.getElementById('current-logo');
            const removeCurrentLogoBtn = document.getElementById('remove-current-logo-btn');
            const loadingOverlay = document.getElementById('loading-overlay');
            
            // Company info elements
            const companyNameInput = document.getElementById('company-name');
            const companyAddressInput = document.getElementById('company-address');
            const companyPhoneInput = document.getElementById('company-phone');
            const companyEmailInput = document.getElementById('company-email');
            const companyCvrInput = document.getElementById('company-cvr');
            
            // Report settings elements
            const senderEmailInput = document.getElementById('sender-email');
            const autoSendToggle = document.getElementById('auto-send-toggle');
            const copyAdminToggle = document.getElementById('copy-admin-toggle');
            
            // Quote settings elements
            const forbeholdTextInput = document.getElementById('forbehold-text');
            const includeForbeholdToggle = document.getElementById('include-forbehold-toggle');
            
            // Initialize
            loadAllSettings();
            setupEventListeners();
            
            function setupEventListeners() {
                // Logo upload
                logoUploadArea?.addEventListener('click', () => logoFileInput?.click());
                logoUploadArea?.addEventListener('dragover', handleDragOver);
                logoUploadArea?.addEventListener('drop', handleDrop);
                logoFileInput?.addEventListener('change', handleFileSelect);
                uploadLogoBtn?.addEventListener('click', uploadLogo);
                removePreviewBtn?.addEventListener('click', removePreview);
                removeCurrentLogoBtn?.addEventListener('click', removeLogo);
            }
            
            async function loadAllSettings() {
                try {
                    showLoading(true, 'Laster innstillinger...');
                    
                    const response = await fetch('/api/images/settings', {
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        currentSettings = await response.json();
                        populateFormFields();
                        console.log('‚úÖ Settings loaded:', currentSettings);
                    } else {
                        throw new Error('Kunne ikke laste innstillinger');
                    }
                } catch (error) {
                    console.error('Error loading settings:', error);
                    showToast('Kunne ikke laste innstillinger: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }
            
            function populateFormFields() {
                // Company info
                if (currentSettings.companyInfo) {
                    companyNameInput.value = currentSettings.companyInfo.name || '';
                    companyAddressInput.value = currentSettings.companyInfo.address || '';
                    companyPhoneInput.value = currentSettings.companyInfo.phone || '';
                    companyEmailInput.value = currentSettings.companyInfo.email || '';
                    companyCvrInput.value = currentSettings.companyInfo.cvr || '';
                }
                
                // Report settings
                if (currentSettings.reportSettings) {
                    senderEmailInput.value = currentSettings.reportSettings.senderEmail || '';
                    autoSendToggle.checked = currentSettings.reportSettings.autoSend || false;
                    copyAdminToggle.checked = currentSettings.reportSettings.copyAdmin || false;
                }
                
                // Quote settings (NEW)
                if (currentSettings.quoteSettings) {
                    forbeholdTextInput.value = currentSettings.quoteSettings.forbeholdText || 'Vi forbeholder oss prisendringer ved endringer hos underleverand√∏rer eller store valuta endringer!';
                    includeForbeholdToggle.checked = currentSettings.quoteSettings.includeForbehold !== false; // Default true
                } else {
                    // Set defaults
                    forbeholdTextInput.value = 'Vi forbeholder oss prisendringer ved endringer hos underleverand√∏rer eller store valuta endringer!';
                    includeForbeholdToggle.checked = true;
                }
                
                // Logo
                if (currentSettings.logo?.url) {
                    currentLogoUrl = currentSettings.logo.url;
                    showCurrentLogo();
                }
            }
            
            function showCurrentLogo() {
                if (currentLogoUrl) {
                    currentLogo.src = currentLogoUrl;
                    currentLogoSection.style.display = 'block';
                } else {
                    currentLogoSection.style.display = 'none';
                }
            }
            
            // File handling functions
            function handleDragOver(e) {
                e.preventDefault();
                e.stopPropagation();
                logoUploadArea.classList.add('drag-over');
            }
            
            function handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                logoUploadArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect({ target: { files } });
                }
            }
            
            function handleFileSelect(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    showToast('Velg kun bildefiler (PNG, JPG, SVG)', 'error');
                    return;
                }
                
                if (file.size > 2 * 1024 * 1024) {
                    showToast('Filen er for stor. Maks 2MB.', 'error');
                    return;
                }
                
                selectedLogoFile = file;
                showLogoPreview(file);
            }
            
            function showLogoPreview(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    logoPreview.src = e.target.result;
                    logoPreviewSection.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
            
            function removePreview() {
                selectedLogoFile = null;
                logoPreviewSection.style.display = 'none';
                logoFileInput.value = '';
            }
            
            async function uploadLogo() {
                if (!selectedLogoFile) return;
                
                try {
                    showLoading(true, 'Laster opp logo...');
                    
                    const formData = new FormData();
                    formData.append('logo', selectedLogoFile);
                    
                    const response = await fetch('/api/images/upload-logo', {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        currentLogoUrl = result.logoUrl;
                        showCurrentLogo();
                        removePreview();
                        showToast('Logo lastet opp!', 'success');
                        await loadAllSettings(); // Refresh settings
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || 'Opplasting feilet');
                    }
                } catch (error) {
                    console.error('Logo upload error:', error);
                    showToast('Feil ved opplasting: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }
            
            async function removeLogo() {
                try {
                    showLoading(true, 'Fjerner logo...');
                    
                    const response = await fetch('/api/images/logo', {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        currentLogoUrl = null;
                        currentLogoSection.style.display = 'none';
                        showToast('Logo fjernet', 'success');
                        await loadAllSettings(); // Refresh settings
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || 'Kunne ikke fjerne logo');
                    }
                } catch (error) {
                    console.error('Logo removal error:', error);
                    showToast('Feil ved fjerning: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }
            
            async function saveReportSettings() {
                try {
                    showLoading(true, 'Lagrer rapport-innstillinger...');
                    
                    const reportSettings = {
                        senderEmail: senderEmailInput.value.trim(),
                        autoSend: autoSendToggle.checked,
                        copyAdmin: copyAdminToggle.checked
                    };
                    
                    const response = await fetch('/api/images/save-settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ reportSettings })
                    });
                    
                    if (response.ok) {
                        showToast('Rapport-innstillinger lagret!', 'success');
                        currentSettings.reportSettings = reportSettings;
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || 'Kunne ikke lagre');
                    }
                } catch (error) {
                    showToast('Feil ved lagring: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }
            
            // NEW: Save quote settings function
            async function saveQuoteSettings() {
                try {
                    showLoading(true, 'Lagrer tilbud-innstillinger...');
                    
                    const quoteSettings = {
                        forbeholdText: forbeholdTextInput.value.trim(),
                        includeForbehold: includeForbeholdToggle.checked
                    };
                    
                    const response = await fetch('/api/images/save-settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ quoteSettings })
                    });
                    
                    if (response.ok) {
                        showToast('Tilbud-innstillinger lagret!', 'success');
                        currentSettings.quoteSettings = quoteSettings;
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || 'Kunne ikke lagre');
                    }
                } catch (error) {
                    showToast('Feil ved lagring: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }
            
            async function saveAllSettings() {
                try {
                    showLoading(true, 'Lagrer innstillinger...');
                    
                    const allSettings = {
                        companyInfo: {
                            name: companyNameInput.value.trim(),
                            address: companyAddressInput.value.trim(),
                            phone: companyPhoneInput.value.trim(),
                            email: companyEmailInput.value.trim(),
                            cvr: companyCvrInput.value.trim()
                        },
                        reportSettings: {
                            senderEmail: senderEmailInput.value.trim(),
                            autoSend: autoSendToggle.checked,
                            copyAdmin: copyAdminToggle.checked
                        },
                        quoteSettings: {
                            forbeholdText: forbeholdTextInput.value.trim(),
                            includeForbehold: includeForbeholdToggle.checked
                        }
                    };
                    
                    const response = await fetch('/api/images/save-settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(allSettings)
                    });
                    
                    if (response.ok) {
                        showToast('Alle innstillinger lagret!', 'success');
                        currentSettings = { ...currentSettings, ...allSettings };
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || 'Kunne ikke lagre');
                    }
                } catch (error) {
                    showToast('Feil ved lagring: ' + error.message, 'error');
                } finally {
                    showLoading(false);
                }
            }
            
            // Utility functions
            function showLoading(show, text = 'Laster...') {
                if (show) {
                    document.getElementById('loading-text').textContent = text;
                    loadingOverlay.style.display = 'flex';
                } else {
                    loadingOverlay.style.display = 'none';
                }
            }
            
            function showToast(message, type = 'info') {
                // Simple toast implementation
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 600;
                    z-index: 10000;
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                `;
                
                if (type === 'success') toast.style.background = '#10b981';
                else if (type === 'error') toast.style.background = '#ef4444';
                else toast.style.background = '#3b82f6';
                
                document.body.appendChild(toast);
                
                setTimeout(() => toast.style.transform = 'translateX(0)', 100);
                setTimeout(() => {
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => document.body.removeChild(toast), 300);
                }, 3000);
            }
            
            // Make functions global
            window.saveReportSettings = saveReportSettings;
            window.saveQuoteSettings = saveQuoteSettings;
            window.saveAllSettings = saveAllSettings;
        });
    </script>
</body>
</html>